# darkquery MVP Documentation

## Overview
darkquery is an interactive CLI tool that uses Ollama to interact with various data sources, providing AI-powered summaries and responses to queries. Currently supports Jira as the first data source implementation. The tool runs in interactive mode by default, enabling natural language queries and command history.

## Core Features

### 1. Model Commands
These are JSON commands generated by the AI model in response to user queries:

- **Data Source Query** (e.g., JQL for Jira)
  ```json
  {"type": "jql", "query": "your JQL query"}
  ```
  - Automatically adds LIMIT clause (1 for single item, 5 for multiple)
  - Example: `{"type": "jql", "query": "creator = currentUser() ORDER BY created DESC LIMIT 1"}`

- **Read Item** (e.g., read_file for files)
  ```json
  {"type": "read_file", "path": "path/to/file"}
  ```
  - Retrieves content from a data source
  - Supports various data formats

- **Fetch Item** (e.g., Jira ticket)
  ```json
  {"type": "fetch_ticket", "ticket_id": "TICKET-123"}
  ```
  - Retrieves details of a specific item from the data source

- **Add Comment**
  ```json
  {"type": "add_comment", "ticket_id": "TICKET-123", "comment": "Your comment text"}
  ```
  - Adds a comment to a specific item
  - Requires user confirmation before posting

### 2. CLI Commands
Commands for launching and configuring the tool:

- `-i, --interactive`: Run in interactive mode (default)
- `-v, --verbose`: Enable model message logging
- `-d, --debug`: Enable debug logging
- `--summary`: Generate detailed summaries

### 3. Interactive Commands
Commands available during interactive sessions:

- `open_last`: Opens the last viewed/referenced item in browser
- `comments`: Show comments for current item
- Up/Down arrows: Navigate command history
- Tab completion: Auto-complete commands and paths

## Architecture

### Prompt Templates
Located in `tools/darkquery/prompts/`:
- `detailed_summary.txt`: Template for comprehensive item analysis
- `concise_summary.txt`: Template for brief item overviews
- `query_response.txt`: Defines available model commands
- `jql_query.txt`: Context for data source queries (Jira-specific)

### Command Handlers
Three types of handlers for different command categories:

1. Model Command Handlers:
   - `JQLCommandHandler`: Handles Jira-specific search commands
   - `TicketCommandHandler`: Handles Jira-specific item commands
   - `ReadCommandHandler`: Handles data source read operations

2. Interactive Command Handlers:
   - `OpenCommandHandler`: Handles browser opening commands
   - `CommentsCommandHandler`: Handles comment viewing
   - `HistoryCommandHandler`: Handles command history navigation

3. Base Classes:
   - `BaseCommandHandler`: Common functionality for all handlers
   - `BaseDataSourceHandler`: Base for data source operations
   - `BaseInteractiveHandler`: Base for interactive commands

### Response Processing
1. Clean response and detect command format
2. For model commands:
   - Parse JSON structure
   - Route to appropriate data source handler
   - Execute command logic
3. For interactive commands:
   - Execute directly through command handlers
   - Update session state
4. For general queries:
   - Clean formatting
   - Display text directly

### Context Selection
1. Use item context if available (for current item queries)
2. Use data source-specific context for general queries
3. Interactive commands bypass model processing

### Data Source Integration
- Abstract interfaces for data source clients
- Data source-specific command handlers
- Extensible prompt system for new data sources
- Common utilities for response formatting

## Debug Features
Enable with `-d` flag:
- Shows command/response processing flow
- Logs context selection decisions
- Tracks handler routing
- Shows error details

## Configuration
- Environment variables in `.env` file:
  - Data Source Configuration (Jira example):
    - `JIRA_URL`: Instance URL
    - `JIRA_EMAIL`: Account email
    - `JIRA_TOKEN`: API token
  - Model Configuration:
    - `OLLAMA_URL`: Ollama API URL (default: http://localhost:11434)
    - `OLLAMA_MODEL`: Model to use (default: mistral)

## Usage Examples

1. Start Tool (Interactive Mode by default):
```bash
darkquery
```

2. Interactive Session with Debug:
```bash
darkquery -v -d
```

3. Example Interactive Commands:
```
> Show my recent tickets
> Read the last ticket's comments
> open_last
> Show tickets assigned to Bob
```

4. Non-Interactive Mode:
```bash
# Generate summary for specific item
darkquery PROJ-123 --summary

# Process multiple items
darkquery PROJ-123 PROJ-124 PROJ-125
```

5. Data Source Examples:
```bash
# Jira ticket
darkquery PROJ-123

# File content (when file source is added)
darkquery path/to/file.txt

# Documentation page (when docs source is added)
darkquery DOC-456
```

## Additional Features

### Command History
- Up/down arrow navigation for previous commands
- History tracking for commands and responses
- Persistent across sessions

### Output Formatting
- Colored output for better readability
- Status indicators for commands
- Formatted timestamps and item information
- Data source-specific formatting helpers

### Error Handling
- Query validation and auto-fixing
- Automatic limit handling for search results
- Interactive confirmation for critical operations
- Detailed error messages in debug mode

### Model Interaction
- Supports both modern and older Ollama API endpoints
- Automatic model availability checking
- Response cleaning and formatting
- Command/response separation logic

## Extending for New Data Sources
To add support for a new data source:
1. Create data source client implementing base interfaces:
   - Query execution
   - Item fetching
   - Comment handling
   - URL generation
2. Add data source-specific command handlers:
   - Query command handler
   - Item command handler
   - Custom command handlers as needed
3. Create data source-specific prompt templates:
   - Query context template
   - Item summary templates
   - Command response templates
4. Update command executor:
   - Register new command handlers
   - Add routing logic for new commands
   - Implement context selection
5. Add configuration:
   - Environment variables
   - Authentication methods
   - API endpoints
   - Default settings

Example Data Sources:
- Issue Trackers: Jira, GitHub Issues, GitLab Issues
- Documentation: Confluence, SharePoint
- Code: GitHub PRs, GitLab MRs
- Knowledge Bases: Internal wikis, documentation sites